#!/usr/bin/env ruby

require 'fileutils'

require_relative '../lib/inits/print_colors'
require_relative '../lib/rubee'

ENV['RACK_ENV'] ||= 'development'

LIB_ROOT = File.expand_path('../lib', File.dirname(__FILE__))
ENV['RACKUP_FILE'] = File.join(LIB_ROOT, 'config.ru')

LOGO = <<-'LOGO'
  ____  _    _  ____  _____
 |  _ \| |  | || __ )| ____|
 | |_) | |  | ||  _ \|  _|
 |  _ <| |__| || |_) | |___
 |_| \_\\____/ |____/|_____|
 Ver: %s
LOGO

command = ARGV.first

Rubee::Autoload.call

Rubee::CLI::Command.new(ARGV).call

if ['console'].include?(command)
  ARGV.clear
  ENV['RACK_ENV'] ||= 'development'

  Rubee::Autoload.call
  if Rubee::PROJECT_NAME == 'rubee'
    Rubee::Configuration.setup(env = :test) do |config|
      config.database_url = { url: 'sqlite://lib/tests/test.db', env: }
    end
    Rubee::Autoload.call
    Rubee::SequelObject.reconnect!
  end

  def reload
    app_files = Dir["./#{Rubee::APP_ROOT}/**/*.rb"]
    app_files.each { |file| load(file) }
    color_puts('Reloaded ..', color: :green)
  end
  begin
    # Start IRB
    IRB.start
  rescue Exception
    IRB.start
  end
else
  color_puts "Unknown command: #{command}", color: :red
end
